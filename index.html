<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BloomWatch | Global Phenology Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        #map-container {
            height: calc(100vh - 80px);
            width: 100%;
            z-index: 0;
        }
        .view {
            display: none;
            min-height: calc(100vh - 80px);
            padding: 2rem;
        }
        .active-view {
            display: block;
        }
        .btn-primary {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(34, 197, 94, 0.3), 0 4px 6px -4px rgba(34, 197, 94, 0.1);
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>
<body class="min-h-screen">

    <nav class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="text-3xl font-extrabold text-green-600 tracking-tight">
                            <i class="fas fa-seedling mr-2"></i>BloomWatch
                        </span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="nav-home" class="text-gray-600 hover:text-green-600 px-3 py-2 rounded-md text-lg font-medium transition duration-150">Home</button>
                    <button id="nav-map" class="text-gray-600 hover:text-green-600 px-3 py-2 rounded-md text-lg font-medium transition duration-150">Map</button>
                    <a href="applications.html" id="nav-applications" class="text-gray-600 hover:text-green-600 px-3 py-2 rounded-md text-lg font-medium transition duration-150">Impact & Applications</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto">
        <div id="home-view" class="view active-view text-gray-800">
            <header class="text-center py-20 bg-green-50 rounded-xl shadow-lg mt-8">
                <h1 class="text-6xl font-extrabold mb-4 text-gray-900">Witness the Pulse of Life.</h1>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto mb-8">
                    BloomWatch harnesses the power of NASA Earth Observations to track, visualize, and predict **plant flowering phenology** around the globe. Understand climate impacts on ecosystems, agriculture, and public health.
                </p>
                <button id="explore-map-btn" class="btn-primary bg-green-600 text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-green-700">
                    Explore the Global Bloom Map
                </button>
            </header>

            <section class="mt-16 bg-white p-8 rounded-xl shadow-lg max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-green-600 mb-4">What is Phenology?</h2>
                <p class="text-gray-700 text-lg">
                    Phenology is the scientific study of seasonal natural events, such as flowering, migration, and breeding in plants and animals, 
                    and how these events are influenced by climate and environmental changes. 
                    By tracking these cycles, phenology helps us understand the timing of natureâ€™s processes and 
                    how ecosystems respond to global warming and other environmental shifts.
                </p>
            </section>

            <section class="mt-16 grid md:grid-cols-3 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-lg transition duration-300 hover:shadow-2xl">
                    <h2 class="text-2xl font-semibold text-green-600 mb-3">Data Driven</h2>
                    <p class="text-gray-600">Utilizing high temporal and spectral resolution data from Landsat, MODIS, and VIIRS to detect subtle changes in vegetation health and flowering cycles.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg transition duration-300 hover:shadow-2xl">
                    <h2 class="text-2xl font-semibold text-green-600 mb-3">Predictive Insights</h2>
                    <p class="text-gray-600">Analyze multi-year trends to forecast peak bloom timing, providing crucial lead time for farmers, allergists, and conservation efforts.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg transition duration-300 hover:shadow-2xl">
                    <h2 class="text-2xl font-semibold text-green-600 mb-3">For All Users</h2>
                    <p class="text-gray-600">Designed for scalability, from global monitoring to informing conservation decisions in your specific local region.</p>
                </div>
            </section>
        </div>

        <div id="map-view" class="view">
            <h1 class="text-3xl font-bold mb-4 text-gray-800">Global Phenology Tracker</h1>
            <p class="text-gray-600 mb-4">Visualizing the intensity and timing of flowering events using the latest NASA Earth Observation data.</p>
            <div id="map-container" class="rounded-xl shadow-xl border-4 border-green-200"></div>
        </div>
    </main>

    <script>
        const app = {
            map: null,
            currentView: 'home-view',
            mapContainerId: 'map-container',
            views: ['home-view', 'map-view'],
            currentGeoJsonLayer: null,

            fetchBloomData: function() {
                const dataPath = './data/bloom_phenology.json'; 
                console.log('Attempting to fetch data from:', dataPath);

                fetch(dataPath)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`File not found or server error (${response.status}).`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`SUCCESS: Loaded ${data.features.length} real bloom points.`);
                        this.loadBloomData(data);
                    })
                    .catch(error => {
                        console.error(`CRITICAL ERROR: Failed to fetch bloom data.`, error.message, 'Falling back to mock data.');
                        this.loadBloomData(this.mockBloomData);
                    });
            },

            mockBloomData: {
                "type": "FeatureCollection",
                "features": [
                    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [-97.7431, 30.2672] }, "properties": { "name": "Texas Wildflower Peak (MOCK)", "intensity": "High", "date": "2025-03-20", "species": "Bluebonnet" } },
                    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [-106.601, 35.106] }, "properties": { "name": "New Mexico Desert Bloom (MOCK)", "intensity": "Medium", "date": "2025-04-15", "species": "Prickly Pear" } },
                    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [-80.1918, 25.7617] }, "properties": { "name": "Florida Citrus Bloom (MOCK)", "intensity": "Very High", "date": "2025-02-01", "species": "Orange Blossom" } }
                ]
            },

            initMap: function() {
                if (this.map) return;

                try {
                    this.map = L.map(this.mapContainerId).setView([20, 0], 2);

                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
                    }).addTo(this.map);

                    this.fetchBloomData();
                    console.log("Leaflet map initialized successfully.");

                } catch (error) {
                    console.error("Error initializing Leaflet map:", error);
                    document.getElementById(this.mapContainerId).innerHTML = '<div class="flex items-center justify-center h-full text-red-600 font-semibold">Error loading map: Check console for details.</div>';
                }
            },

            loadBloomData: function(data) {
                if (this.currentGeoJsonLayer) {
                    this.map.removeLayer(this.currentGeoJsonLayer);
                }

                const getMarkerColor = (intensity) => {
                    switch (intensity) {
                        case 'Very High': return 'red';
                        case 'High': return 'orange';
                        case 'Medium': return 'yellow';
                        default: return 'green';
                    }
                };

                this.currentGeoJsonLayer = L.geoJSON(data, {
                    pointToLayer: (feature, latlng) => {
                        return L.circleMarker(latlng, {
                            radius: 8,
                            fillColor: getMarkerColor(feature.properties.intensity),
                            color: "#000",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.7
                        });
                    },
                    onEachFeature: (feature, layer) => {
                        if (feature.properties) {
                            const props = feature.properties;
                            layer.bindPopup(`
                                <h3 class="font-bold">${props.name || 'Bloom Event'}</h3>
                                <strong>Species:</strong> ${props.species || 'N/A'}<br>
                                <strong>Intensity:</strong> ${props.intensity || 'N/A'}<br>
                                <strong>Peak Date:</strong> ${props.date || 'N/A'}<br>
                                <p class="text-xs mt-2">Data Source: NASA MODIS NDVI</p>
                            `);
                        }
                    }
                }).addTo(this.map);
                
                if (data.features.length > 0) {
                    const bounds = this.currentGeoJsonLayer.getBounds();
                    if (bounds.isValid()) {
                        this.map.fitBounds(bounds, { padding: [50, 50] });
                    } else {
                        console.warn("Bounds invalid. Manually setting view to the first point.");
                        const firstCoord = data.features[0].geometry.coordinates;
                        this.map.setView([firstCoord[1], firstCoord[0]], 8); 
                    }
                }
            },

            showView: function(viewId) {
                this.views.forEach(id => {
                    document.getElementById(id).classList.remove('active-view');
                });

                const newView = document.getElementById(viewId);
                newView.classList.add('active-view');

                this.currentView = viewId;

                if (viewId === this.mapContainerId.replace('-container', '-view')) {
                    this.initMap();
                    if (this.map) {
                        setTimeout(() => {
                            this.map.invalidateSize();
                            if (this.currentGeoJsonLayer) {
                                const bounds = this.currentGeoJsonLayer.getBounds();
                                if (bounds.isValid()) {
                                    this.map.fitBounds(bounds, { padding: [50, 50] });
                                } else {
                                    const firstCoord = this.currentGeoJsonLayer.toGeoJSON().features[0].geometry.coordinates;
                                    this.map.setView([firstCoord[1], firstCoord[0]], 8);
                                }
                            }
                        }, 500);
                    }
                }
            },

            init: function() {
                document.getElementById('nav-home').addEventListener('click', () => this.showView('home-view'));
                document.getElementById('nav-map').addEventListener('click', () => this.showView('map-view'));
                document.getElementById('explore-map-btn').addEventListener('click', () => this.showView('map-view'));
                this.showView('home-view');
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
