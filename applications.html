<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bloom Shift & Solar Irradiance Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-trendline"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
</head>

<body class="bg-gray-50 min-h-screen text-gray-800">
  <header class="text-center py-6 bg-gradient-to-r from-amber-100 to-green-100 shadow">
    <h1 class="text-3xl font-bold text-green-800 mb-2">ðŸŒ¸ Bloom Shift & Solar Irradiance Explorer</h1>
    <p class="text-gray-600 text-sm">Compare flowering shifts with real NASA irradiance data (2000â€“2025)</p>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <section class="mb-6">
      <div class="flex flex-col md:flex-row gap-3 items-center justify-center">
        <select id="regionSelect" class="p-2 border rounded-lg shadow-sm">
          <option value="kerala">Kerala</option>
          <option value="punjab">Punjab</option>
        </select>
        <input id="customPlace" placeholder="or type a place name..." class="p-2 border rounded-lg shadow-sm w-64" />
        <button id="fetchDataBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2">
          <i class="fa-solid fa-seedling"></i> Load Data
        </button>
      </div>
    </section>

    <!-- Spinner -->
    <div id="loadingSpinner" class="hidden flex justify-center items-center py-10">
      <i class="fa-solid fa-spinner fa-spin text-4xl text-green-600"></i>
    </div>

    <!-- Chart -->
    <section class="bg-white shadow-md rounded-2xl p-6 mb-8">
      <canvas id="bloomChart" height="120"></canvas>
      <div class="flex justify-center gap-3 mt-4">
        <button id="downloadAnnual" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Download Annual CSV</button>
        <button id="downloadMonthly" class="bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-700">Download Monthly CSV</button>
      </div>
    </section>

    <!-- Roadmap -->
    <section class="bg-green-50 rounded-2xl shadow-inner p-6 border border-green-200">
      <h2 class="text-2xl font-semibold text-green-800 mb-4">ðŸŒ¾ Bloom & Harvest Roadmap</h2>
      <div id="roadmapContent" class="space-y-4"></div>
    </section>
  </main>

  <script>
    const NASA_API_KEY = "QtWg50ks1bsg0Mw9eTkxoeiMrTcc68qx53VzefEK"; // <--- insert your NASA API key here
    const ctx = document.getElementById('bloomChart').getContext('2d');
    let bloomChart;

    const presetCoords = {
      kerala: { lat: 10.85, lon: 76.27, crop: "Mango" },
      punjab: { lat: 31.15, lon: 75.34, crop: "Wheat" }
    };

    document.getElementById('fetchDataBtn').addEventListener('click', async () => {
      const region = document.getElementById('regionSelect').value;
      const place = document.getElementById('customPlace').value.trim();
      const spinner = document.getElementById('loadingSpinner');
      spinner.classList.remove('hidden');

      try {
        let lat, lon, cropName;

        if (place) {
          const geoResp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`);
          const geoData = await geoResp.json();
          if (geoData.length === 0) throw new Error("Location not found");
          lat = parseFloat(geoData[0].lat);
          lon = parseFloat(geoData[0].lon);
          cropName = "Local Crops";
        } else {
          lat = presetCoords[region].lat;
          lon = presetCoords[region].lon;
          cropName = presetCoords[region].crop;
        }

        const nasaURL = `https://power.larc.nasa.gov/api/temporal/monthly/point?parameters=ALLSKY_SFC_SW_DWN&community=RE&longitude=${lon}&latitude=${lat}&start=2000&end=2025&format=JSON&api_key=${NASA_API_KEY}`;
        const res = await fetch(nasaURL);
        const data = await res.json();

        const monthlyData = data?.properties?.parameter?.ALLSKY_SFC_SW_DWN;
        if (!monthlyData) throw new Error("NASA data unavailable");

        const annualAverages = {};
        Object.entries(monthlyData).forEach(([ym, val]) => {
          const yr = ym.substring(0, 4);
          annualAverages[yr] = annualAverages[yr] || [];
          annualAverages[yr].push(val);
        });
        const years = Object.keys(annualAverages);
        const irradiance = years.map(y => annualAverages[y].reduce((a,b)=>a+b,0)/12);

        // Fake blooming data for demo (shift earlier with irradiance)
        const bloomingDates = irradiance.map(v => 120 - (v - 180) * 0.3);

        renderChart(years, bloomingDates, irradiance);
        renderRoadmap({ name: cropName, region: place || region, shift: "Earlier by ~10 days" });
        setupCSV(years, irradiance, bloomingDates, monthlyData);
      } catch (err) {
        alert("âš ï¸ " + err.message);
      } finally {
        spinner.classList.add('hidden');
      }
    });

    function renderChart(years, bloom, irradiance) {
      if (bloomChart) bloomChart.destroy();
      bloomChart = new Chart(ctx, {
        data: {
          labels: years,
          datasets: [
            {
              label: 'Blooming Date (Day of Year)',
              data: bloom,
              yAxisID: 'y',
              borderColor: '#16a34a',
              backgroundColor: '#bbf7d0',
              trendlineLinear: { colorMin: "#16a34a", colorMax: "#166534", lineStyle: "solid", width: 2 }
            },
            {
              label: 'Solar Irradiance (kWh/mÂ²/day)',
              data: irradiance,
              yAxisID: 'y1',
              borderColor: '#eab308',
              backgroundColor: '#fef9c3',
              trendlineLinear: { colorMin: "#facc15", colorMax: "#ca8a04", lineStyle: "solid", width: 2 }
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          stacked: false,
          plugins: { legend: { position: 'bottom' } },
          scales: {
            y: { type: 'linear', position: 'left', title: { display: true, text: 'Blooming Date (DOY)' } },
            y1: { type: 'linear', position: 'right', title: { display: true, text: 'Irradiance (kWh/mÂ²/day)' }, grid: { drawOnChartArea: false } }
          }
        }
      });
    }

    function setupCSV(years, irradiance, bloom, monthlyData) {
      document.getElementById('downloadAnnual').onclick = () => {
        let csv = "Year,Irradiance (kWh/mÂ²/day),Blooming Date (DOY)\n";
        years.forEach((y,i)=> csv += `${y},${irradiance[i]},${bloom[i]}\n`);
        downloadCSV(csv, "annual_data.csv");
      };
      document.getElementById('downloadMonthly').onclick = () => {
        let csv = "YearMonth,ALLSKY_SFC_SW_DWN\n";
        for (const [ym,val] of Object.entries(monthlyData)) csv += `${ym},${val}\n`;
        downloadCSV(csv, "monthly_data.csv");
      };
    }

    function downloadCSV(content, fileName) {
      const blob = new Blob([content], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(url);
    }

    function renderRoadmap(data) {
      const roadmapContent = document.getElementById('roadmapContent');
      const monthLabels = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"].map(m => `<span>${m}</span>`).join('');
      const segments = `
        <div class="absolute inset-0 flex">
          <div class="bg-green-300 h-full w-1/4"></div>
          <div class="bg-yellow-300 h-full w-1/4"></div>
          <div class="bg-orange-300 h-full w-1/4"></div>
          <div class="bg-red-300 h-full w-1/4"></div>
        </div>
      `;
      const isShifted = data.shift.includes("earlier") || data.shift.includes("later");
      const shiftBg = isShifted ? "bg-red-100 border-red-500" : "bg-green-100 border-green-400";

      roadmapContent.innerHTML = `
        <div class="relative bg-gray-50 rounded-xl shadow-inner h-16 mb-6 border border-gray-200 overflow-hidden">
          <div class="absolute inset-0 flex justify-between px-2 text-gray-400 text-xs font-semibold">
            ${monthLabels}
          </div>
          ${segments}
        </div>
        <div class="text-center ${shiftBg} border rounded-xl p-4">
          <p class="text-lg font-semibold text-gray-800">
            ${data.name} in ${data.region}
          </p>
          <p class="text-gray-700 leading-snug mt-1">
            Observed change: <span class="font-bold">${data.shift}</span>
          </p>
        </div>
      `;
    }
  </script>
</body>
</html>
